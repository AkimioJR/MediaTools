name: Core Builder for Binary

on:
  workflow_call:

# concurrency:
#   group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
#   cancel-in-progress: true

jobs:
  build-binary-core:
    strategy:
      matrix:
        include:
          - platform: ubuntu-22.04
            goos: linux
            goarch: amd64
          - platform: ubuntu-22.04-arm
            goos: linux
            goarch: arm64

          - platform: macos-latest
            goos: darwin
            goarch: amd64
          - platform: macos-latest
            goos: darwin
            goarch: arm64

          - platform: windows-latest
            goos: windows
            goarch: amd64
            extension: .exe
          # - platform: windows-11-arm
          #   goos: windows
          #   goarch: arm64
          #   extension: .exe

    name: Build ${{ matrix.goos }}(${{ matrix.goarch }}) Binary Core
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Dependency
        if: matrix.goos == 'linux'
        run: |
          sudo bash scripts/linux.sh

      - name: Download web build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: web/dist/

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23 # 使用低版本通过 GOTOOLCHAIN 自动下载更高版本

      - name: Install Wails
        shell: bash
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          echo $GITHUB_PATH
          echo $PATH
          # 验证 wails 是否可用
          which wails
          wails version

      - name: Build
        shell: bash
        env:
          GOTOOLCHAIN: auto
          CGO_ENABLED: 1
          GO111MODULE: on
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go run scripts/build.go -desktop -os ${{ matrix.goos }} -arch ${{ matrix.goarch }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MediaTools-${{ matrix.goos }}-${{ matrix.goarch }}
          path: build/bin/MediaTools-*
